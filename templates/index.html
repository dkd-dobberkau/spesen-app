<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spesenabrechnung - Olivier Dobberkau</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!-- PDF.js für PDF-Rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root { --primary-color: #333333; }
        .nav-wrapper, .btn, .btn-floating { background-color: var(--primary-color) !important; }
        .btn.green { background-color: #4CAF50 !important; }
        .btn.blue { background-color: #2196F3 !important; }
        .tabs .tab a { color: var(--primary-color); }
        .tabs .tab a.active { border-bottom: 2px solid var(--primary-color); }
        .tabs .indicator { background-color: var(--primary-color); }
        body { background-color: #f5f5f5; }
        .card { border-radius: 8px; }
        .card-title { color: var(--primary-color) !important; font-weight: 500; }
        .expense-item {
            background: #fafafa;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary-color);
        }
        .expense-item:hover { background: #f0f0f0; }
        .delete-btn { cursor: pointer; color: #999; }
        .delete-btn:hover { color: var(--primary-color); }
        .sum-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-align: right;
        }
        .category-sum {
            background: #f5f5f5;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .input-field input:focus, .input-field textarea:focus { border-bottom: 1px solid var(--primary-color) !important; box-shadow: 0 1px 0 0 var(--primary-color) !important; }
        .input-field input:focus + label, .input-field textarea:focus + label { color: var(--primary-color) !important; }
        [type="checkbox"]:checked + span:not(.lever)::before { border-right-color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .export-section { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .collapsible-header {
            font-weight: 500;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
        }
        .collapsible-header i.material-icons:first-child {
            color: var(--primary-color);
            margin-right: 15px;
        }
        .collapsible-header .header-text {
            flex: 1;
            font-size: 1rem;
            color: #333;
        }
        .collapsible-header .badge-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .collapsible-header .badge {
            background-color: var(--primary-color) !important;
            color: white !important;
            min-width: 24px;
            text-align: center;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.85rem;
        }
        .collapsible-header .sum-badge {
            background-color: #e8f5e9 !important;
            color: #2e7d32 !important;
            font-weight: 600;
            min-width: 80px;
            text-align: right;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.95rem;
        }
        .collapsible-header .sum-badge.has-value {
            background-color: #c8e6c9 !important;
        }
        .collapsible li {
            border: none;
            margin-bottom: 2px;
        }
        .collapsible li.active .collapsible-header {
            background: #f5f5f5;
            border-left: 3px solid var(--primary-color);
        }
        .collapsible-body {
            padding: 15px 20px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }
        .total-card { background: linear-gradient(135deg, #333333, #555555); color: white; }
        .total-card .card-title { color: white !important; }
        @media only screen and (max-width: 600px) {
            .export-section { bottom: 10px; right: 10px; left: 10px; }
            .export-section .btn { width: 100%; margin: 5px 0; }
            .collapsible-header .sum-badge { min-width: 60px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a href="#" class="brand-logo center">Spesenabrechnung</a>
            <ul class="right">
                <li><a href="#!" onclick="openBelegScanner()" title="Beleg scannen"><i class="material-icons">document_scanner</i></a></li>
                <li><a href="#!" onclick="openPersonen()" title="Personen verwalten"><i class="material-icons">people</i></a></li>
                <li><a href="#!" onclick="openSettings()" title="Einstellungen"><i class="material-icons">settings</i></a></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="margin-top: 20px; margin-bottom: 100px;">
        <!-- Meta Information -->
        <div class="card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">info</i>Abrechnung</span>
                <div class="row" style="margin-bottom: 0;">
                    <div class="input-field col s6 m4">
                        <input id="meta-monat" type="text" value="">
                        <label for="meta-monat">Monat / Zeitraum</label>
                    </div>
                    <div class="input-field col s6 m4">
                        <input id="meta-datum" type="text" class="datepicker">
                        <label for="meta-datum" class="active">Datum</label>
                    </div>
                    <div class="col s12 m4" style="padding-top: 15px;">
                        <span class="grey-text" id="display-name"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Display -->
        <div class="card total-card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">account_balance_wallet</i>Gesamtsumme</span>
                <div class="sum-display" id="total-sum" style="color: white; font-size: 2rem;">0,00 €</div>
            </div>
        </div>

        <!-- Expense Categories -->
        <ul class="collapsible expandable">
            <!-- 1. Fahrtkosten mit priv. Kfz -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">directions_car</i>
                    <span class="header-text">1. Fahrtkosten mit priv. Kfz.</span>
                    <div class="badge-container">
                        <span class="badge" id="badge-fahrtkosten_kfz">0</span>
                        <span class="sum-badge" id="sum-fahrtkosten_kfz">0,00 €</span>
                    </div>
                </div>
                <div class="collapsible-body">
                    <div id="list-fahrtkosten_kfz"></div>
                    <div class="row" style="margin-top: 15px;">
                        <div class="input-field col s6 m2">
                            <input type="text" class="datepicker" id="fahrtkosten_kfz-datum">
                            <label for="fahrtkosten_kfz-datum">Datum</label>
                        </div>
                        <div class="input-field col s6 m3">
                            <input type="text" id="fahrtkosten_kfz-fahrstrecke">
                            <label for="fahrtkosten_kfz-fahrstrecke">Fahrstrecke</label>
                        </div>
                        <div class="input-field col s6 m3">
                            <input type="text" id="fahrtkosten_kfz-anlass">
                            <label for="fahrtkosten_kfz-anlass">Anlaß</label>
                        </div>
                        <div class="input-field col s4 m2">
                            <input type="number" id="fahrtkosten_kfz-km" step="1">
                            <label for="fahrtkosten_kfz-km">km</label>
                        </div>
                        <div class="col s2 m2" style="margin-top: 25px;">
                            <a class="btn-floating waves-effect waves-light" onclick="addExpense('fahrtkosten_kfz')">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </div>
                    <p class="grey-text">Kilometerpauschale: 0,30 €/km</p>
                </div>
            </li>

            <!-- 2. Fahrtkosten Öffentliche Verkehrsmittel -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">train</i>
                    <span class="header-text">2. Fahrtkosten ÖPNV</span>
                    <div class="badge-container">
                        <span class="badge" id="badge-fahrtkosten_pauschale">0</span>
                        <span class="sum-badge" id="sum-fahrtkosten_pauschale">0,00 €</span>
                    </div>
                </div>
                <div class="collapsible-body">
                    <div id="list-fahrtkosten_pauschale"></div>
                    <div class="row" style="margin-top: 15px;">
                        <div class="input-field col s6 m3">
                            <input type="text" id="fahrtkosten_pauschale-monat">
                            <label for="fahrtkosten_pauschale-monat">Monat</label>
                        </div>
                        <div class="input-field col s6 m5">
                            <input type="text" id="fahrtkosten_pauschale-beschreibung" value="i.H.v. RMV Ticket">
                            <label for="fahrtkosten_pauschale-beschreibung" class="active">Beschreibung</label>
                        </div>
                        <div class="input-field col s4 m2">
                            <input type="number" id="fahrtkosten_pauschale-betrag" step="0.01">
                            <label for="fahrtkosten_pauschale-betrag">Betrag €</label>
                        </div>
                        <div class="col s2 m2" style="margin-top: 25px;">
                            <a class="btn-floating waves-effect waves-light" onclick="addExpense('fahrtkosten_pauschale')">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </div>
                </div>
            </li>

            <!-- 3. Bewirtungskosten -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">restaurant</i>
                    <span class="header-text">3. Bewirtungskosten</span>
                    <div class="badge-container">
                        <span class="badge" id="badge-bewirtung">0</span>
                        <span class="sum-badge" id="sum-bewirtung">0,00 €</span>
                    </div>
                </div>
                <div class="collapsible-body">
                    <div id="list-bewirtung"></div>
                    <div class="row" style="margin-top: 15px;">
                        <div class="input-field col s6 m2">
                            <input type="text" class="datepicker" id="bewirtung-datum">
                            <label for="bewirtung-datum">Datum</label>
                        </div>
                        <div class="input-field col s6 m6">
                            <input type="text" id="bewirtung-personen">
                            <label for="bewirtung-personen">Bewirtete Personen (auf Beleg)</label>
                        </div>
                        <div class="input-field col s4 m2">
                            <input type="number" id="bewirtung-betrag" step="0.01">
                            <label for="bewirtung-betrag">Betrag €</label>
                        </div>
                        <div class="col s2 m2" style="margin-top: 25px;">
                            <a class="btn-floating waves-effect waves-light" onclick="addExpense('bewirtung')">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </div>
                </div>
            </li>

            <!-- 4-8: Simple Categories -->
            {% for cat_key, cat_name in [('fachliteratur', 'Fachliteratur'), ('bueromaterial', 'Büromaterial'), ('telefonkosten', 'Telefonkosten'), ('software', 'Software'), ('getraenke', 'Getränke')] %}
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">{% if cat_key == 'fachliteratur' %}book{% elif cat_key == 'bueromaterial' %}print{% elif cat_key == 'telefonkosten' %}phone{% elif cat_key == 'software' %}computer{% else %}local_cafe{% endif %}</i>
                    <span class="header-text">{{ loop.index + 3 }}. {{ cat_name }}</span>
                    <div class="badge-container">
                        <span class="badge" id="badge-{{ cat_key }}">0</span>
                        <span class="sum-badge" id="sum-{{ cat_key }}">0,00 €</span>
                    </div>
                </div>
                <div class="collapsible-body">
                    <div id="list-{{ cat_key }}"></div>
                    <div class="row" style="margin-top: 15px;">
                        <div class="input-field col s6 m2">
                            <input type="text" class="datepicker" id="{{ cat_key }}-datum">
                            <label for="{{ cat_key }}-datum">Datum</label>
                        </div>
                        <div class="input-field col s6 m6">
                            <input type="text" id="{{ cat_key }}-beschreibung">
                            <label for="{{ cat_key }}-beschreibung">Beschreibung</label>
                        </div>
                        <div class="input-field col s4 m2">
                            <input type="number" id="{{ cat_key }}-betrag" step="0.01">
                            <label for="{{ cat_key }}-betrag">Betrag €</label>
                        </div>
                        <div class="col s2 m2" style="margin-top: 25px;">
                            <a class="btn-floating waves-effect waves-light" onclick="addExpense('{{ cat_key }}')">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}

            <!-- 9. Sonstiges -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">more_horiz</i>
                    <span class="header-text">9. Sonstiges</span>
                    <div class="badge-container">
                        <span class="badge" id="badge-sonstiges">0</span>
                        <span class="sum-badge" id="sum-sonstiges">0,00 €</span>
                    </div>
                </div>
                <div class="collapsible-body">
                    <div id="list-sonstiges"></div>
                    <div class="row" style="margin-top: 15px;">
                        <div class="input-field col s6 m2">
                            <select id="sonstiges-typ" onchange="onSonstigesTypChange()">
                                <option value="Parken">Parken</option>
                                <option value="Taxi">Taxi</option>
                                <option value="Verpflegungspauschale">Verpflegungspauschale</option>
                                <option value="Uber">Uber</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                            <label>Typ</label>
                        </div>
                        <div class="input-field col s6 m2">
                            <input type="text" class="datepicker" id="sonstiges-datum">
                            <label for="sonstiges-datum">Datum</label>
                        </div>
                        <div class="input-field col s6 m2" id="vp-land-container" style="display: none;">
                            <select id="sonstiges-vp-land" onchange="onVPLandChange()">
                                {% for land in verpflegungspauschalen.keys() %}
                                <option value="{{ land }}">{{ land }}</option>
                                {% endfor %}
                            </select>
                            <label>Land</label>
                        </div>
                        <div class="input-field col s6 m2" id="vp-dauer-container" style="display: none;">
                            <select id="sonstiges-vp-dauer" onchange="onVPDauerChange()">
                                <option value="halbtag">8-24h (Halbtag)</option>
                                <option value="ganztag">24h+ (Ganztag)</option>
                            </select>
                            <label>Dauer</label>
                        </div>
                        <div class="input-field col s6 m2" id="ort-container">
                            <input type="text" id="sonstiges-ort">
                            <label for="sonstiges-ort">Ort / Beschreibung</label>
                        </div>
                        <div class="input-field col s4 m2">
                            <input type="number" id="sonstiges-betrag" step="0.01">
                            <label for="sonstiges-betrag">Betrag €</label>
                        </div>
                        <div class="col s2 m2" style="margin-top: 25px;">
                            <a class="btn-floating waves-effect waves-light" onclick="addExpense('sonstiges')">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <!-- Export Buttons -->
    <div class="export-section">
        <a class="btn waves-effect waves-light green" onclick="saveToDatabase()" style="margin-right: 10px;">
            <i class="material-icons left">save</i>Speichern
        </a>
        <a class="btn waves-effect waves-light blue" onclick="openLoadModal()" style="margin-right: 10px;">
            <i class="material-icons left">folder_open</i>Laden
        </a>
        <a class="btn waves-effect waves-light" onclick="exportExcel()" style="margin-right: 10px;">
            <i class="material-icons left">table_chart</i>Excel
        </a>
        <a class="btn waves-effect waves-light" onclick="exportPDF()" style="margin-right: 10px;">
            <i class="material-icons left">picture_as_pdf</i>PDF
        </a>
        <a class="btn waves-effect waves-light purple" onclick="exportZIP()">
            <i class="material-icons left">archive</i>ZIP (komplett)
        </a>
    </div>

    <!-- Load Modal -->
    <div id="load-modal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left">folder_open</i>Abrechnung laden</h4>
            <div id="abrechnungen-list">
                <p class="grey-text center">Lade Abrechnungen...</p>
            </div>
        </div>
        <div class="modal-footer">
            <a class="btn-flat waves-effect waves-light" onclick="newAbrechnung()">
                <i class="material-icons left">add</i>Neue Abrechnung
            </a>
            <a href="#!" class="modal-close btn-flat">Schließen</a>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left">edit</i>Eintrag bearbeiten</h4>
            <input type="hidden" id="edit-category">
            <input type="hidden" id="edit-index">
            <div id="edit-fields"></div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Abbrechen</a>
            <a href="#!" class="btn waves-effect waves-light" onclick="saveEdit()">
                <i class="material-icons left">save</i>Speichern
            </a>
        </div>
    </div>

    <!-- Beleg Scanner Modal -->
    <div id="beleg-modal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4><i class="material-icons left">document_scanner</i>Beleg scannen</h4>
            <p class="grey-text">Laden Sie einen Beleg hoch (Foto oder PDF). Die Daten werden automatisch erkannt.</p>

            <div id="upload-area" style="border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; margin: 20px 0; transition: all 0.3s;">
                <i class="material-icons" style="font-size: 48px; color: #999;">cloud_upload</i>
                <p style="margin: 10px 0;">Beleg hierher ziehen oder klicken zum Auswählen</p>
                <p class="grey-text" style="font-size: 12px;">Unterstützt: JPG, PNG, PDF</p>
                <input type="file" id="beleg-input" accept=".jpg,.jpeg,.png,.pdf,.tiff" style="display: none;">
            </div>

            <div id="scan-progress" style="display: none; text-align: center; padding: 20px;">
                <div class="preloader-wrapper active">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left"><div class="circle"></div></div>
                        <div class="gap-patch"><div class="circle"></div></div>
                        <div class="circle-clipper right"><div class="circle"></div></div>
                    </div>
                </div>
                <p>Beleg wird analysiert...</p>
            </div>

            <div id="scan-result" style="display: none;">
                <h5>Erkannte Daten</h5>
                <div class="row">
                    <div class="input-field col s6">
                        <input type="text" id="beleg-datum">
                        <label for="beleg-datum" class="active">Datum</label>
                    </div>
                    <div class="input-field col s6">
                        <input type="number" id="beleg-betrag" step="0.01">
                        <label for="beleg-betrag" class="active">Betrag €</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <select id="beleg-kategorie">
                            <option value="">Kategorie wählen...</option>
                            <option value="fahrtkosten_kfz">Fahrtkosten Kfz</option>
                            <option value="fahrtkosten_pauschale">Fahrtkosten ÖPNV</option>
                            <option value="bewirtung">Bewirtungskosten</option>
                            <option value="fachliteratur">Fachliteratur</option>
                            <option value="bueromaterial">Büromaterial</option>
                            <option value="telefonkosten">Telefonkosten</option>
                            <option value="software">Software</option>
                            <option value="getraenke">Getränke</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                        <label>Kategorie</label>
                    </div>
                    <div class="input-field col s6">
                        <input type="text" id="beleg-beschreibung">
                        <label for="beleg-beschreibung" class="active">Beschreibung</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        <label>Erkannter Text (zur Kontrolle)</label>
                        <textarea id="beleg-rawtext" class="materialize-textarea" style="font-size: 11px; min-height: 200px; max-height: 400px; background: #f5f5f5; padding: 10px; overflow-y: auto;" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Abbrechen</a>
            <a href="#!" class="btn waves-effect waves-light" id="btn-add-beleg" onclick="addBelegToExpenses()" style="display: none;">
                <i class="material-icons left">add</i>Hinzufügen
            </a>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal modal-fixed-footer" style="max-height: 85%;">
        <div class="modal-content">
            <h4><i class="material-icons left">settings</i>Einstellungen</h4>
            <p class="grey-text">Diese Daten werden lokal in einer verschlüsselten Datenbank gespeichert und für alle Abrechnungen verwendet.</p>

            <h5>Persönliche Daten</h5>
            <div class="row">
                <div class="input-field col s12">
                    <input id="settings-name" type="text">
                    <label for="settings-name">Name</label>
                </div>
                <div class="input-field col s12">
                    <input id="settings-iban" type="text" placeholder="DE00 0000 0000 0000 0000 00">
                    <label for="settings-iban" class="active">IBAN</label>
                </div>
                <div class="input-field col s12">
                    <input id="settings-bic" type="text" placeholder="DEUTDEDB">
                    <label for="settings-bic" class="active">BIC (optional)</label>
                </div>
                <div class="input-field col s12">
                    <input id="settings-bank" type="text" placeholder="Deutsche Bank">
                    <label for="settings-bank" class="active">Bank (optional)</label>
                </div>
            </div>

            <h5>Unterschrift</h5>
            <p class="grey-text" style="font-size: 0.9em;">PNG-Bild für Bewirtungsbelege (transparent empfohlen)</p>
            <div class="row">
                <div class="col s12">
                    <div id="unterschrift-preview" style="border: 1px dashed #ccc; padding: 10px; min-height: 80px; text-align: center; margin-bottom: 10px; background: #f9f9f9;">
                        <span class="grey-text">Keine Unterschrift hochgeladen</span>
                    </div>
                    <div class="file-field input-field">
                        <div class="btn btn-small">
                            <span>PNG hochladen</span>
                            <input type="file" id="unterschrift-upload" accept="image/png">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text" placeholder="Unterschrift auswählen...">
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Abbrechen</a>
            <a href="#!" class="btn waves-effect waves-light" onclick="saveSettings()">
                <i class="material-icons left">save</i>Speichern
            </a>
        </div>
    </div>

    <!-- Personen-Modal -->
    <div id="personen-modal" class="modal modal-fixed-footer" style="max-height: 85%;">
        <div class="modal-content">
            <h4><i class="material-icons left">people</i>Personen verwalten</h4>
            <p class="grey-text">Häufig bewirtete Personen für schnelle Auswahl bei Bewirtungsbelegen.</p>

            <!-- VCF Import -->
            <div class="row" style="margin-top: 20px;">
                <div class="col s12">
                    <div class="file-field input-field">
                        <div class="btn btn-small blue">
                            <span><i class="material-icons left">upload_file</i>VCF importieren</span>
                            <input type="file" id="vcf-upload" accept=".vcf,.vcard">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text" placeholder="Kontakte aus VCF-Datei importieren...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personen-Liste -->
            <h5>Gespeicherte Personen</h5>
            <div id="personen-liste" style="margin-bottom: 15px; max-height: 300px; overflow-y: auto;">
                <p class="grey-text center">Lade Personen...</p>
            </div>

            <!-- Neue Person hinzufügen -->
            <h5>Person hinzufügen</h5>
            <div class="row">
                <div class="input-field col s5">
                    <input id="neue-person-name" type="text" placeholder=" ">
                    <label for="neue-person-name">Name</label>
                </div>
                <div class="input-field col s5">
                    <input id="neue-person-firma" type="text" placeholder=" ">
                    <label for="neue-person-firma">Firma/Funktion</label>
                </div>
                <div class="col s2" style="padding-top: 15px;">
                    <a href="#!" class="btn-small waves-effect waves-light" onclick="addNewPerson()">
                        <i class="material-icons">add</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Schließen</a>
        </div>
    </div>

    <!-- Bewirtungsbeleg Modal -->
    <div id="bewirtungsbeleg-modal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4><i class="material-icons left">receipt_long</i>Bewirtungsbeleg erstellen</h4>
            <p class="grey-text">Ergänzen Sie die bewirteten Personen für den offiziellen Bewirtungsbeleg nach § 4 Abs. 5 Nr. 2 EStG.</p>

            <div class="row">
                <div class="input-field col s6 m3">
                    <input id="bew-datum" type="text" readonly>
                    <label for="bew-datum" class="active">Datum</label>
                </div>
                <div class="input-field col s6 m3">
                    <input id="bew-betrag" type="text" readonly>
                    <label for="bew-betrag" class="active">Betrag</label>
                </div>
                <div class="input-field col s12 m6">
                    <input id="bew-restaurant" type="text">
                    <label for="bew-restaurant" class="active">Restaurant</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="bew-personen-original" type="text">
                    <label for="bew-personen-original" class="active">Bewirtete Personen (aus Beleg)</label>
                    <span class="helper-text">Dieser Wert wird auch im Haupteintrag aktualisiert</span>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="bew-anlass" type="text" value="Geschäftliche Besprechung">
                    <label for="bew-anlass" class="active">Anlass der Bewirtung</label>
                </div>
            </div>

            <h5>Bewirtete Personen</h5>
            <p class="grey-text" style="font-size: 0.9em;">Name und Firma/Funktion der Teilnehmer</p>

            <!-- Ausgewählte Teilnehmer als Chips -->
            <div id="ausgewaehlte-teilnehmer" style="margin-bottom: 15px; min-height: 32px;">
                <!-- Wird dynamisch befüllt -->
            </div>

            <!-- Autocomplete für Person hinzufügen -->
            <div class="row" style="margin-bottom: 0;">
                <div class="input-field col s10">
                    <i class="material-icons prefix">person_add</i>
                    <input type="text" id="teilnehmer-autocomplete" class="autocomplete" placeholder=" ">
                    <label for="teilnehmer-autocomplete">Person hinzufügen (tippen für Vorschläge)</label>
                </div>
                <div class="col s2" style="padding-top: 15px;">
                    <a href="#!" class="btn-small waves-effect waves-light" onclick="addTeilnehmerManual()" title="Hinzufügen">
                        <i class="material-icons">add</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Abbrechen</a>
            <a href="#!" class="btn waves-effect waves-light green" onclick="downloadBewirtungsbeleg()">
                <i class="material-icons left">picture_as_pdf</i>PDF erstellen
            </a>
        </div>
    </div>

    <!-- Beleg-Viewer Modal -->
    <div id="beleg-viewer-modal" class="modal modal-fixed-footer" style="width: 95%; max-width: 1200px; height: 90%;">
        <div class="modal-content" style="padding: 10px; height: calc(100% - 56px);">
            <div id="beleg-viewer-container" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                <div id="beleg-viewer-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                    <h5 style="margin: 0; flex: 1; min-width: 200px;"><i class="material-icons left">attach_file</i><span id="beleg-viewer-title">Beleg</span></h5>
                    <div id="pdf-controls" style="display: none; align-items: center; gap: 10px;">
                        <button class="btn-small waves-effect waves-light" onclick="pdfPrevPage()" title="Vorherige Seite">
                            <i class="material-icons">chevron_left</i>
                        </button>
                        <span id="pdf-page-info" style="min-width: 80px; text-align: center;">1 / 1</span>
                        <button class="btn-small waves-effect waves-light" onclick="pdfNextPage()" title="Nächste Seite">
                            <i class="material-icons">chevron_right</i>
                        </button>
                        <button class="btn-small waves-effect waves-light" onclick="pdfZoomOut()" title="Verkleinern">
                            <i class="material-icons">zoom_out</i>
                        </button>
                        <span id="pdf-zoom-info" style="min-width: 50px; text-align: center;">100%</span>
                        <button class="btn-small waves-effect waves-light" onclick="pdfZoomIn()" title="Vergrößern">
                            <i class="material-icons">zoom_in</i>
                        </button>
                        <button class="btn-small waves-effect waves-light" onclick="pdfFitWidth()" title="An Breite anpassen">
                            <i class="material-icons">fit_screen</i>
                        </button>
                    </div>
                    <a href="#!" id="beleg-download-btn" class="btn-small waves-effect waves-light green" download>
                        <i class="material-icons left">download</i>Download
                    </a>
                </div>
                <div id="beleg-viewer-content" style="flex: 1; overflow: auto; background: #e0e0e0; border-radius: 4px; display: flex; justify-content: center; align-items: flex-start; padding: 10px;">
                    <!-- PDF/Bild wird hier angezeigt -->
                    <canvas id="pdf-canvas" style="display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.3); background: white;"></canvas>
                    <div id="image-container" style="display: none; text-align: center;">
                        <img id="beleg-image" style="max-width: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                    </div>
                    <div id="beleg-loading" style="display: none; text-align: center; padding: 50px;">
                        <div class="preloader-wrapper active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                        <p>Lade Beleg...</p>
                    </div>
                    <div id="beleg-error" style="display: none; text-align: center; padding: 50px;">
                        <i class="material-icons" style="font-size: 48px; color: #999;">error</i>
                        <p class="red-text">Beleg nicht gefunden</p>
                        <p class="grey-text" id="beleg-error-msg"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Schließen</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        // Bewirtungsbeleg-Index für aktuellen Eintrag
        let currentBewirtungIndex = null;

        // Data storage
        const expenses = {
            fahrtkosten_kfz: [],
            fahrtkosten_pauschale: [],
            bewirtung: [],
            fachliteratur: [],
            bueromaterial: [],
            telefonkosten: [],
            software: [],
            getraenke: [],
            sonstiges: []
        };

        const categoryConfig = {
            fahrtkosten_kfz: { fields: ['datum', 'fahrstrecke', 'anlass', 'km'], rate: 0.30 },
            fahrtkosten_pauschale: { fields: ['monat', 'beschreibung', 'betrag'] },
            bewirtung: { fields: ['datum', 'personen', 'betrag'] },
            fachliteratur: { fields: ['datum', 'beschreibung', 'betrag'] },
            bueromaterial: { fields: ['datum', 'beschreibung', 'betrag'] },
            telefonkosten: { fields: ['datum', 'beschreibung', 'betrag'] },
            software: { fields: ['datum', 'beschreibung', 'betrag'] },
            getraenke: { fields: ['datum', 'beschreibung', 'betrag'] },
            sonstiges: { fields: ['typ', 'datum', 'ort', 'betrag'] }
        };

        // Initialize Materialize components
        document.addEventListener('DOMContentLoaded', function() {
            M.Collapsible.init(document.querySelectorAll('.collapsible'), { accordion: false });
            M.Datepicker.init(document.querySelectorAll('.datepicker'), {
                format: 'dd.mm.yyyy',
                firstDay: 1,
                i18n: {
                    months: ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'],
                    monthsShort: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                    weekdays: ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'],
                    weekdaysShort: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'],
                    weekdaysAbbrev: ['S', 'M', 'D', 'M', 'D', 'F', 'S'],
                    cancel: 'Abbrechen',
                    done: 'OK'
                }
            });
            M.FormSelect.init(document.querySelectorAll('select'));
            
            // Set today's date
            const today = new Date();
            document.getElementById('meta-datum').value = today.toLocaleDateString('de-DE');
            
            // Load from localStorage
            loadData();
        });

        function addExpense(category) {
            const config = categoryConfig[category];
            const expense = {};
            
            config.fields.forEach(field => {
                const input = document.getElementById(`${category}-${field}`);
                if (input.tagName === 'SELECT') {
                    expense[field] = input.options[input.selectedIndex].value;
                } else {
                    expense[field] = input.value;
                }
                if (input.tagName !== 'SELECT') input.value = '';
            });
            
            if (category === 'fahrtkosten_kfz' && !expense.km) return;
            if (category !== 'fahrtkosten_kfz' && !expense.betrag) return;
            
            expenses[category].push(expense);
            renderCategory(category);
            updateTotals();
            saveData();

            // Wenn aus DB geladen, auch dort speichern
            if (currentAbrechnungId) {
                saveToDatabase();
            }

            M.toast({html: 'Eintrag hinzugefügt', classes: 'rounded'});
        }

        function deleteExpense(category, index) {
            expenses[category].splice(index, 1);
            renderCategory(category);
            updateTotals();
            saveData();

            // Wenn aus DB geladen, auch dort speichern
            if (currentAbrechnungId) {
                saveToDatabase();
            }
        }

        // Berechnet die Startnummer für eine Kategorie (fortlaufend über alle Kategorien)
        function getStartNumberForCategory(category) {
            const categoryOrder = Object.keys(expenses);
            let startNr = 1;
            for (const cat of categoryOrder) {
                if (cat === category) break;
                startNr += expenses[cat].length;
            }
            return startNr;
        }

        function renderCategory(category) {
            const list = document.getElementById(`list-${category}`);
            const config = categoryConfig[category];

            // Badge immer aktualisieren
            document.getElementById(`badge-${category}`).textContent = expenses[category].length;

            if (expenses[category].length === 0) {
                list.innerHTML = '<p class="grey-text center">Keine Einträge</p>';
                return;
            }

            // Startnummer für diese Kategorie berechnen
            const startNr = getStartNumberForCategory(category);

            let html = '';
            expenses[category].forEach((exp, index) => {
                const belegNr = startNr + index;
                let betrag = 0;
                let details = '';
                
                if (category === 'fahrtkosten_kfz') {
                    betrag = parseFloat(exp.km || 0) * 0.30;
                    details = `${exp.datum} | ${exp.fahrstrecke} | ${exp.anlass} | ${exp.km} km`;
                } else if (category === 'sonstiges') {
                    betrag = parseFloat(exp.betrag || 0);
                    details = `${exp.typ} | ${exp.datum} | ${exp.ort}`;
                } else if (category === 'bewirtung') {
                    betrag = parseFloat(exp.betrag || 0);
                    details = `${exp.datum} | ${exp.personen}`;
                    // Bewirtungsbeleg-Button hinzufügen
                    exp._showBewirtungsbeleg = true;
                } else {
                    betrag = parseFloat(exp.betrag || 0);
                    details = `${exp.datum || exp.monat} | ${exp.beschreibung}`;
                }
                
                const bewirtungBtn = exp._showBewirtungsbeleg
                    ? `<i class="material-icons delete-btn" onclick="generateBewirtungsbeleg(${index})" style="margin-right: 10px;" title="Bewirtungsbeleg erstellen">receipt_long</i>`
                    : '';

                // Beleg-Anzeige Button (nur wenn file_hash vorhanden)
                const belegBtn = exp.file_hash
                    ? `<i class="material-icons delete-btn" onclick="showBeleg('${exp.file_hash}')" style="margin-right: 10px;" title="Beleg anzeigen">attach_file</i>`
                    : '';

                html += `
                    <div class="expense-item row valign-wrapper" style="margin-bottom: 5px;">
                        <div class="col s1" style="min-width: 35px;"><span class="badge grey lighten-2" style="border-radius: 4px; padding: 2px 6px;">${belegNr}</span></div>
                        <div class="col s5 m6">${details}</div>
                        <div class="col s3 m2 right-align"><strong>${betrag.toFixed(2)} €</strong></div>
                        <div class="col s3 m3 right-align">
                            ${belegBtn}
                            ${bewirtungBtn}
                            <i class="material-icons delete-btn" onclick="editExpense('${category}', ${index})" style="margin-right: 10px;" title="Bearbeiten">edit</i>
                            <i class="material-icons delete-btn" onclick="deleteExpense('${category}', ${index})" title="Löschen">delete</i>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function calculateCategorySum(category) {
            return expenses[category].reduce((sum, exp) => {
                if (category === 'fahrtkosten_kfz') {
                    return sum + (parseFloat(exp.km || 0) * 0.30);
                }
                return sum + parseFloat(exp.betrag || 0);
            }, 0);
        }

        function updateTotals() {
            let total = 0;
            Object.keys(expenses).forEach(category => {
                const sum = calculateCategorySum(category);
                const sumBadge = document.getElementById(`sum-${category}`);
                sumBadge.textContent = sum.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
                if (sum > 0) {
                    sumBadge.classList.add('has-value');
                } else {
                    sumBadge.classList.remove('has-value');
                }
                total += sum;
            });
            document.getElementById('total-sum').textContent = total.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
        }

        function getMeta() {
            return {
                monat: document.getElementById('meta-monat').value,
                name: userSettings.name,
                datum: document.getElementById('meta-datum').value,
                iban: userSettings.iban,
                bic: userSettings.bic,
                bank: userSettings.bank
            };
        }

        function exportExcel() {
            const data = { meta: getMeta(), expenses: expenses };
            fetch('/export/excel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Spesen_${getMeta().monat.replace(' ', '_')}.xlsx`;
                a.click();
                M.toast({html: 'Excel exportiert', classes: 'rounded green'});
            });
        }

        function exportPDF() {
            const data = { meta: getMeta(), expenses: expenses };
            fetch('/export/pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Spesen_${getMeta().monat.replace(' ', '_')}.pdf`;
                a.click();
                M.toast({html: 'PDF exportiert', classes: 'rounded green'});
            });
        }

        function exportZIP() {
            M.toast({html: 'ZIP wird erstellt...', classes: 'rounded'});
            const data = { meta: getMeta(), expenses: expenses };
            fetch('/export/zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error('Export fehlgeschlagen');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Spesen_${getMeta().monat.replace(' ', '_')}_komplett.zip`;
                a.click();
                M.toast({html: 'ZIP exportiert (Excel + Belege)', classes: 'rounded green'});
            })
            .catch(err => {
                M.toast({html: 'Fehler: ' + err.message, classes: 'rounded red'});
            });
        }

        function saveData() {
            localStorage.setItem('spesen-data', JSON.stringify({ meta: getMeta(), expenses: expenses }));
        }

        function loadData() {
            const saved = localStorage.getItem('spesen-data');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.meta) {
                    document.getElementById('meta-monat').value = data.meta.monat || '';
                    document.getElementById('meta-name').value = data.meta.name || '';
                    document.getElementById('meta-konto').value = data.meta.konto || '';
                    document.getElementById('meta-blz').value = data.meta.blz || '';
                    M.updateTextFields();
                }
                if (data.expenses) {
                    Object.assign(expenses, data.expenses);
                    Object.keys(expenses).forEach(renderCategory);
                    updateTotals();
                }
            }
        }

        // SQLite Database Functions
        let currentAbrechnungId = null;

        function saveToDatabase() {
            const meta = getMeta();
            if (currentAbrechnungId) {
                meta.id = currentAbrechnungId;
            }

            fetch('/api/abrechnungen', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meta: meta, expenses: expenses })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentAbrechnungId = data.id;
                    M.toast({html: 'Gespeichert in Datenbank!', classes: 'rounded green'});
                } else {
                    M.toast({html: 'Fehler beim Speichern', classes: 'rounded red'});
                }
            })
            .catch(err => {
                M.toast({html: 'Fehler: ' + err.message, classes: 'rounded red'});
            });
        }

        function openLoadModal() {
            const modal = M.Modal.getInstance(document.getElementById('load-modal'));
            modal.open();
            loadAbrechnungenList();
        }

        function loadAbrechnungenList() {
            const listDiv = document.getElementById('abrechnungen-list');
            listDiv.innerHTML = '<p class="grey-text center">Lade...</p>';

            fetch('/api/abrechnungen')
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    listDiv.innerHTML = '<p class="grey-text center">Keine gespeicherten Abrechnungen</p>';
                    return;
                }

                let html = '<ul class="collection">';
                data.forEach(abr => {
                    html += `
                        <li class="collection-item">
                            <div>
                                <strong>${abr.name}</strong> - ${abr.monat}
                                <span class="grey-text"> (${abr.datum || 'kein Datum'})</span>
                                <a href="#!" class="secondary-content" onclick="deleteAbrechnung(${abr.id}, event)" title="Löschen">
                                    <i class="material-icons red-text">delete</i>
                                </a>
                                <a href="#!" class="secondary-content" onclick="loadAbrechnung(${abr.id})" style="margin-right: 20px;" title="Laden">
                                    <i class="material-icons blue-text">open_in_new</i>
                                </a>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                listDiv.innerHTML = html;
            })
            .catch(err => {
                listDiv.innerHTML = '<p class="red-text center">Fehler beim Laden</p>';
            });
        }

        function loadAbrechnung(id) {
            fetch(`/api/abrechnungen/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    M.toast({html: 'Abrechnung nicht gefunden', classes: 'rounded red'});
                    return;
                }

                // Meta-Daten setzen
                currentAbrechnungId = data.meta.id;
                document.getElementById('meta-monat').value = data.meta.monat || '';
                document.getElementById('meta-datum').value = data.meta.datum || '';
                M.updateTextFields();

                // Ausgaben laden
                Object.keys(expenses).forEach(key => expenses[key] = []);
                Object.assign(expenses, data.expenses);
                Object.keys(expenses).forEach(renderCategory);
                updateTotals();

                // Modal schließen
                const modal = M.Modal.getInstance(document.getElementById('load-modal'));
                modal.close();

                M.toast({html: `${data.meta.monat} geladen`, classes: 'rounded green'});
            })
            .catch(err => {
                M.toast({html: 'Fehler beim Laden: ' + err.message, classes: 'rounded red'});
            });
        }

        function deleteAbrechnung(id, event) {
            event.stopPropagation();
            if (!confirm('Abrechnung wirklich löschen?')) return;

            fetch(`/api/abrechnungen/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (currentAbrechnungId === id) {
                        currentAbrechnungId = null;
                    }
                    M.toast({html: 'Gelöscht', classes: 'rounded'});
                    loadAbrechnungenList();
                }
            });
        }

        function newAbrechnung() {
            currentAbrechnungId = null;
            Object.keys(expenses).forEach(key => expenses[key] = []);
            Object.keys(expenses).forEach(renderCategory);
            updateTotals();

            document.getElementById('meta-monat').value = '';
            document.getElementById('meta-datum').value = new Date().toLocaleDateString('de-DE');
            M.updateTextFields();

            const modal = M.Modal.getInstance(document.getElementById('load-modal'));
            modal.close();

            M.toast({html: 'Neue Abrechnung', classes: 'rounded'});
        }

        // Initialize modal
        document.addEventListener('DOMContentLoaded', function() {
            M.Modal.init(document.querySelectorAll('.modal'));
            loadSettings();
            loadPersonen();  // Personen für Bewirtungsbeleg-Chips laden
        });

        // Settings functions
        let userSettings = {
            name: '',
            iban: '',
            bic: '',
            bank: ''
        };

        function openSettings() {
            document.getElementById('settings-name').value = userSettings.name || '';
            document.getElementById('settings-iban').value = userSettings.iban || '';
            document.getElementById('settings-bic').value = userSettings.bic || '';
            document.getElementById('settings-bank').value = userSettings.bank || '';
            M.updateTextFields();

            // Unterschrift laden
            loadUnterschrift();

            const modal = M.Modal.getInstance(document.getElementById('settings-modal'));
            modal.open();
        }

        function openPersonen() {
            // Felder leeren
            document.getElementById('neue-person-name').value = '';
            document.getElementById('neue-person-firma').value = '';
            M.updateTextFields();

            loadPersonen();
            const modal = M.Modal.getInstance(document.getElementById('personen-modal'));
            modal.open();
        }

        // Unterschrift-Vorschau
        let unterschriftBase64 = null;

        document.addEventListener('DOMContentLoaded', function() {
            const uploadInput = document.getElementById('unterschrift-upload');
            if (uploadInput) {
                uploadInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type === 'image/png') {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            unterschriftBase64 = event.target.result;
                            updateUnterschriftPreview(unterschriftBase64);

                            // Direkt speichern
                            fetch('/api/unterschrift', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ unterschrift_base64: unterschriftBase64 })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    M.toast({html: 'Unterschrift gespeichert', classes: 'rounded green'});
                                }
                            });
                        };
                        reader.readAsDataURL(file);
                    } else {
                        M.toast({html: 'Bitte nur PNG-Dateien', classes: 'rounded orange'});
                    }
                });
            }

            // VCF Upload Handler
            const vcfUploadInput = document.getElementById('vcf-upload');
            if (vcfUploadInput) {
                vcfUploadInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('vcf', file);

                        fetch('/api/personen/import-vcf', {
                            method: 'POST',
                            body: formData
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                loadPersonen();
                                M.toast({html: `${data.imported} Personen importiert (${data.skipped} übersprungen)`, classes: 'rounded green'});
                            } else {
                                M.toast({html: data.error || 'Import fehlgeschlagen', classes: 'rounded red'});
                            }
                            // Input zurücksetzen
                            vcfUploadInput.value = '';
                        })
                        .catch(err => {
                            M.toast({html: 'Fehler beim Import: ' + err.message, classes: 'rounded red'});
                            vcfUploadInput.value = '';
                        });
                    }
                });
            }
        });

        function loadUnterschrift() {
            fetch('/api/unterschrift')
            .then(res => res.json())
            .then(data => {
                if (data.unterschrift_base64) {
                    unterschriftBase64 = data.unterschrift_base64;
                    updateUnterschriftPreview(unterschriftBase64);
                }
            });
        }

        function updateUnterschriftPreview(base64) {
            const preview = document.getElementById('unterschrift-preview');
            if (base64) {
                preview.innerHTML = `<img src="${base64}" style="max-height: 60px; max-width: 200px;">`;
            } else {
                preview.innerHTML = '<span class="grey-text">Keine Unterschrift hochgeladen</span>';
            }
        }

        // Personen-Verwaltung
        let gespeichertePersonen = [];

        function loadPersonen() {
            fetch('/api/personen')
            .then(res => res.json())
            .then(data => {
                gespeichertePersonen = data;
                renderPersonenListe();
            });
        }

        function renderPersonenListe() {
            const liste = document.getElementById('personen-liste');
            if (gespeichertePersonen.length === 0) {
                liste.innerHTML = '<p class="grey-text center" style="font-size: 0.9em;">Noch keine Personen gespeichert</p>';
                return;
            }

            let html = '<div class="collection">';
            gespeichertePersonen.forEach(p => {
                const escapedName = p.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const escapedFirma = (p.firma || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                html += `
                    <div class="collection-item" id="person-row-${p.id}" style="display: flex; align-items: center; padding: 10px 15px;">
                        <span class="person-display" style="flex: 1;"><strong>${p.name}</strong>${p.firma ? ' - ' + p.firma : ''}</span>
                        <div class="person-edit" style="display: none; flex: 1; gap: 10px;">
                            <input type="text" id="edit-name-${p.id}" value="${escapedName}" style="margin: 0; height: 2rem; width: 45%;">
                            <input type="text" id="edit-firma-${p.id}" value="${escapedFirma}" placeholder="Firma" style="margin: 0; height: 2rem; width: 45%;">
                        </div>
                        <div class="person-actions" style="display: flex; gap: 5px;">
                            <a href="#!" class="btn-edit" onclick="editPerson(${p.id})" title="Bearbeiten">
                                <i class="material-icons grey-text">edit</i>
                            </a>
                            <a href="#!" class="btn-save" onclick="savePerson(${p.id})" title="Speichern" style="display: none;">
                                <i class="material-icons green-text">check</i>
                            </a>
                            <a href="#!" class="btn-cancel" onclick="cancelEditPerson(${p.id})" title="Abbrechen" style="display: none;">
                                <i class="material-icons orange-text">close</i>
                            </a>
                            <a href="#!" class="btn-delete" onclick="deletePerson(${p.id})" title="Löschen">
                                <i class="material-icons grey-text">delete</i>
                            </a>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            liste.innerHTML = html;
        }

        function editPerson(id) {
            const row = document.getElementById(`person-row-${id}`);
            row.querySelector('.person-display').style.display = 'none';
            row.querySelector('.person-edit').style.display = 'flex';
            row.querySelector('.btn-edit').style.display = 'none';
            row.querySelector('.btn-delete').style.display = 'none';
            row.querySelector('.btn-save').style.display = 'inline';
            row.querySelector('.btn-cancel').style.display = 'inline';
            document.getElementById(`edit-name-${id}`).focus();
        }

        function cancelEditPerson(id) {
            const row = document.getElementById(`person-row-${id}`);
            row.querySelector('.person-display').style.display = 'inline';
            row.querySelector('.person-edit').style.display = 'none';
            row.querySelector('.btn-edit').style.display = 'inline';
            row.querySelector('.btn-delete').style.display = 'inline';
            row.querySelector('.btn-save').style.display = 'none';
            row.querySelector('.btn-cancel').style.display = 'none';
        }

        function savePerson(id) {
            const name = document.getElementById(`edit-name-${id}`).value.trim();
            const firma = document.getElementById(`edit-firma-${id}`).value.trim();

            if (!name) {
                M.toast({html: 'Name ist erforderlich', classes: 'rounded orange'});
                return;
            }

            fetch(`/api/personen/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, firma })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadPersonen();
                    M.toast({html: 'Person aktualisiert', classes: 'rounded green'});
                } else {
                    M.toast({html: data.error || 'Fehler beim Speichern', classes: 'rounded red'});
                }
            });
        }

        function addNewPerson() {
            const name = document.getElementById('neue-person-name').value.trim();
            const firma = document.getElementById('neue-person-firma').value.trim();

            if (!name) {
                M.toast({html: 'Name ist erforderlich', classes: 'rounded orange'});
                return;
            }

            fetch('/api/personen', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, firma })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('neue-person-name').value = '';
                    document.getElementById('neue-person-firma').value = '';
                    loadPersonen();
                    M.toast({html: 'Person hinzugefügt', classes: 'rounded green'});
                }
            });
        }

        function deletePerson(id) {
            fetch(`/api/personen/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadPersonen();
                }
            });
        }

        function saveSettings() {
            userSettings.name = document.getElementById('settings-name').value;
            userSettings.iban = document.getElementById('settings-iban').value;
            userSettings.bic = document.getElementById('settings-bic').value;
            userSettings.bank = document.getElementById('settings-bank').value;

            // Save to SQLite via API (encrypted)
            fetch('/api/einstellungen', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userSettings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDisplayName();
                    const modal = M.Modal.getInstance(document.getElementById('settings-modal'));
                    modal.close();
                    M.toast({html: 'Einstellungen gespeichert (verschlüsselt)', classes: 'rounded green'});
                } else {
                    M.toast({html: 'Fehler beim Speichern', classes: 'rounded red'});
                }
            })
            .catch(err => {
                M.toast({html: 'Fehler: ' + err.message, classes: 'rounded red'});
            });
        }

        function loadSettings() {
            fetch('/api/einstellungen')
            .then(response => response.json())
            .then(data => {
                userSettings = data;
                updateDisplayName();

                // Wenn keine Einstellungen vorhanden, Hinweis zeigen
                if (!userSettings.name) {
                    setTimeout(() => {
                        M.toast({html: 'Bitte Einstellungen ausfüllen (Zahnrad oben rechts)', classes: 'rounded'});
                    }, 1000);
                }
            })
            .catch(err => {
                console.error('Fehler beim Laden der Einstellungen:', err);
            });
        }

        function updateDisplayName() {
            const displayEl = document.getElementById('display-name');
            if (userSettings.name) {
                displayEl.textContent = userSettings.name;
            } else {
                displayEl.innerHTML = '<em>Name in Einstellungen hinterlegen</em>';
            }
        }

        // Bewirtungsbeleg-Funktionen
        function generateBewirtungsbeleg(index) {
            currentBewirtungIndex = index;
            const exp = expenses.bewirtung[index];

            // Felder befüllen
            document.getElementById('bew-datum').value = exp.datum || '';
            document.getElementById('bew-betrag').value = parseFloat(exp.betrag || 0).toFixed(2) + ' €';

            // Restaurant und Personen aus "personen" Feld extrahieren
            // Format kann sein: "Restaurant" oder "Restaurant - Personen"
            const personenFeld = exp.personen || '';
            let restaurant = personenFeld;
            let bewirtetePersonen = '';

            // Prüfen ob " - " als Trenner vorhanden ist
            const separatorIndex = personenFeld.indexOf(' - ');
            if (separatorIndex > 0) {
                restaurant = personenFeld.substring(0, separatorIndex);
                bewirtetePersonen = personenFeld.substring(separatorIndex + 3);
            }

            document.getElementById('bew-restaurant').value = restaurant;
            document.getElementById('bew-personen-original').value = bewirtetePersonen;

            // Anlass aus gespeichertem Wert oder Default
            document.getElementById('bew-anlass').value = exp.anlass || 'Geschäftliche Besprechung';

            // Teilnehmer aus gespeicherten Daten laden
            ausgewaehlteTeilnehmer = exp.teilnehmer ? [...exp.teilnehmer] : [];
            renderTeilnehmerChips();

            // Autocomplete initialisieren
            initTeilnehmerAutocomplete();

            // Autocomplete-Feld leeren
            document.getElementById('teilnehmer-autocomplete').value = '';

            // Modal öffnen
            M.updateTextFields();
            const modal = M.Modal.getInstance(document.getElementById('bewirtungsbeleg-modal'));
            modal.open();
        }

        // Ausgewählte Teilnehmer für Bewirtungsbeleg
        let ausgewaehlteTeilnehmer = [];

        function initTeilnehmerAutocomplete() {
            const autocompleteData = {};
            gespeichertePersonen.forEach(p => {
                const displayText = p.firma ? `${p.name} (${p.firma})` : p.name;
                autocompleteData[displayText] = null;
            });

            const elem = document.getElementById('teilnehmer-autocomplete');
            if (elem) {
                M.Autocomplete.init(elem, {
                    data: autocompleteData,
                    onAutocomplete: function(selected) {
                        addTeilnehmerFromAutocomplete(selected);
                        elem.value = '';
                    },
                    minLength: 0
                });
            }
        }

        function addTeilnehmerFromAutocomplete(selected) {
            // Parse name und firma aus dem selected string "Name (Firma)"
            let name = selected;
            let firma = '';
            const match = selected.match(/^(.+?)\s*\((.+)\)$/);
            if (match) {
                name = match[1].trim();
                firma = match[2].trim();
            }

            addTeilnehmer(name, firma);
        }

        function addTeilnehmerManual() {
            const input = document.getElementById('teilnehmer-autocomplete');
            const value = input.value.trim();
            if (!value) {
                M.toast({html: 'Bitte Namen eingeben', classes: 'rounded orange'});
                return;
            }

            // Prüfen ob es eine gespeicherte Person ist
            let name = value;
            let firma = '';
            const match = value.match(/^(.+?)\s*\((.+)\)$/);
            if (match) {
                name = match[1].trim();
                firma = match[2].trim();
            } else {
                // Suche in gespeicherten Personen nach genauem Namen
                const found = gespeichertePersonen.find(p => p.name.toLowerCase() === value.toLowerCase());
                if (found) {
                    firma = found.firma || '';
                }
            }

            addTeilnehmer(name, firma);
            input.value = '';
        }

        function addTeilnehmer(name, firma) {
            // Prüfen ob Person bereits in der Liste ist
            if (ausgewaehlteTeilnehmer.some(t => t.name.toLowerCase() === name.toLowerCase())) {
                M.toast({html: 'Person bereits hinzugefügt', classes: 'rounded orange'});
                return;
            }

            ausgewaehlteTeilnehmer.push({ name, firma });
            renderTeilnehmerChips();
            M.toast({html: name + ' hinzugefügt', classes: 'rounded green'});
        }

        function removeTeilnehmer(index) {
            ausgewaehlteTeilnehmer.splice(index, 1);
            renderTeilnehmerChips();
        }

        function renderTeilnehmerChips() {
            const container = document.getElementById('ausgewaehlte-teilnehmer');
            if (ausgewaehlteTeilnehmer.length === 0) {
                container.innerHTML = '<span class="grey-text" style="font-size: 0.9em;">Noch keine Teilnehmer ausgewählt</span>';
                return;
            }

            let html = '';
            ausgewaehlteTeilnehmer.forEach((t, index) => {
                html += `<div class="chip">
                    ${t.name}${t.firma ? ' <span class="grey-text">(' + t.firma + ')</span>' : ''}
                    <i class="close material-icons" onclick="removeTeilnehmer(${index})">close</i>
                </div>`;
            });
            container.innerHTML = html;
        }

        function downloadBewirtungsbeleg() {
            const exp = expenses.bewirtung[currentBewirtungIndex];

            // Teilnehmer aus ausgewaehlteTeilnehmer Array
            if (ausgewaehlteTeilnehmer.length === 0) {
                M.toast({html: 'Bitte mindestens eine Person hinzufügen', classes: 'rounded orange'});
                return;
            }

            const teilnehmer = [...ausgewaehlteTeilnehmer];

            // Aktualisierte Werte aus dem Modal holen
            const restaurant = document.getElementById('bew-restaurant').value.trim();
            const bewirtetePersonen = document.getElementById('bew-personen-original').value.trim();
            const anlass = document.getElementById('bew-anlass').value.trim();

            // Haupteintrag aktualisieren
            let neuesPersonenFeld = restaurant;
            if (bewirtetePersonen) {
                neuesPersonenFeld = restaurant + ' - ' + bewirtetePersonen;
            }
            expenses.bewirtung[currentBewirtungIndex].personen = neuesPersonenFeld;
            expenses.bewirtung[currentBewirtungIndex].teilnehmer = teilnehmer;  // Teilnehmer speichern
            expenses.bewirtung[currentBewirtungIndex].anlass = anlass;  // Anlass speichern
            renderCategory('bewirtung');
            saveData();

            // Wenn aus DB geladen, auch dort speichern
            if (currentAbrechnungId) {
                saveToDatabase();
            }

            // Monat für Ordnername
            const monat = document.getElementById('meta-monat').value || 'Unbekannt';

            // Belegnummer berechnen (gleiche Nummer wie in der Liste)
            const startNr = getStartNumberForCategory('bewirtung');
            const belegNr = startNr + currentBewirtungIndex;

            const data = {
                datum: exp.datum,
                restaurant: restaurant,
                ort: '',  // Kann erweitert werden
                betrag: parseFloat(exp.betrag || 0),
                anlass: document.getElementById('bew-anlass').value,
                bewirtende_person: userSettings.name || '',
                teilnehmer: teilnehmer,
                unterschrift_base64: unterschriftBase64,  // Unterschrift für PDF
                monat: monat,  // Für Ordnerstruktur
                beleg_nr: belegNr  // Fortlaufende Belegnummer
            };

            fetch('/export/bewirtungsbeleg', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                // Dateiname aus Content-Disposition Header lesen
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'Bewirtungsbeleg.pdf';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?([^";\n]+)"?/);
                    if (match) filename = match[1];
                }
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                const modal = M.Modal.getInstance(document.getElementById('bewirtungsbeleg-modal'));
                modal.close();
                M.toast({html: 'Bewirtungsbeleg erstellt und gespeichert', classes: 'rounded green'});
            })
            .catch(err => {
                M.toast({html: 'Fehler: ' + err.message, classes: 'rounded red'});
            });
        }

        // Verpflegungspauschalen 2025
        const verpflegungspauschalen = {{ verpflegungspauschalen | tojson }};

        function onSonstigesTypChange() {
            const typ = document.getElementById('sonstiges-typ').value;
            const vpLandContainer = document.getElementById('vp-land-container');
            const vpDauerContainer = document.getElementById('vp-dauer-container');
            const ortContainer = document.getElementById('ort-container');

            if (typ === 'Verpflegungspauschale') {
                vpLandContainer.style.display = 'block';
                vpDauerContainer.style.display = 'block';
                ortContainer.style.display = 'none';
                M.FormSelect.init(document.getElementById('sonstiges-vp-land'));
                M.FormSelect.init(document.getElementById('sonstiges-vp-dauer'));
                updateVPBetrag();
            } else {
                vpLandContainer.style.display = 'none';
                vpDauerContainer.style.display = 'none';
                ortContainer.style.display = 'block';
                document.getElementById('sonstiges-betrag').value = '';
            }
        }

        function onVPLandChange() {
            updateVPBetrag();
        }

        function onVPDauerChange() {
            updateVPBetrag();
        }

        function updateVPBetrag() {
            const land = document.getElementById('sonstiges-vp-land').value;
            const dauer = document.getElementById('sonstiges-vp-dauer').value;

            if (verpflegungspauschalen[land]) {
                const betrag = verpflegungspauschalen[land][dauer];
                document.getElementById('sonstiges-betrag').value = betrag.toFixed(2);
                // Ort-Feld mit Land und Dauer füllen
                const dauerText = dauer === 'ganztag' ? '24h+' : '8-24h';
                document.getElementById('sonstiges-ort').value = `${land} (${dauerText})`;
            }
        }

        // Edit-Funktionen
        const fieldLabels = {
            datum: 'Datum',
            fahrstrecke: 'Fahrstrecke',
            anlass: 'Anlaß',
            km: 'Kilometer',
            monat: 'Monat',
            beschreibung: 'Beschreibung',
            betrag: 'Betrag €',
            personen: 'Restaurant / Ort',
            typ: 'Typ',
            ort: 'Ort / Beschreibung'
        };

        function editExpense(category, index) {
            const expense = expenses[category][index];
            const config = categoryConfig[category];

            document.getElementById('edit-category').value = category;
            document.getElementById('edit-index').value = index;

            let html = '<div class="row">';
            config.fields.forEach(field => {
                const value = expense[field] || '';
                const label = fieldLabels[field] || field;

                if (field === 'typ' && category === 'sonstiges') {
                    html += `
                        <div class="input-field col s12 m6">
                            <select id="edit-${field}">
                                <option value="Parken" ${value === 'Parken' ? 'selected' : ''}>Parken</option>
                                <option value="Taxi" ${value === 'Taxi' ? 'selected' : ''}>Taxi</option>
                                <option value="Verpflegungspauschale" ${value === 'Verpflegungspauschale' ? 'selected' : ''}>Verpflegungspauschale</option>
                                <option value="Uber" ${value === 'Uber' ? 'selected' : ''}>Uber</option>
                                <option value="Sonstiges" ${value === 'Sonstiges' ? 'selected' : ''}>Sonstiges</option>
                            </select>
                            <label>${label}</label>
                        </div>
                    `;
                } else if (field === 'km' || field === 'betrag') {
                    html += `
                        <div class="input-field col s12 m6">
                            <input type="number" id="edit-${field}" value="${value}" step="${field === 'km' ? '1' : '0.01'}">
                            <label class="active" for="edit-${field}">${label}</label>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="input-field col s12 m6">
                            <input type="text" id="edit-${field}" value="${value}">
                            <label class="active" for="edit-${field}">${label}</label>
                        </div>
                    `;
                }
            });
            html += '</div>';

            document.getElementById('edit-fields').innerHTML = html;

            // Initialize select elements
            M.FormSelect.init(document.querySelectorAll('#edit-modal select'));

            const modal = M.Modal.getInstance(document.getElementById('edit-modal'));
            modal.open();
        }

        function saveEdit() {
            const category = document.getElementById('edit-category').value;
            const index = parseInt(document.getElementById('edit-index').value);
            const config = categoryConfig[category];

            // Bestehenden Eintrag holen (um file_hash etc. zu erhalten)
            const existingExpense = expenses[category][index] || {};

            const updatedExpense = {};
            config.fields.forEach(field => {
                const input = document.getElementById(`edit-${field}`);
                if (input.tagName === 'SELECT') {
                    updatedExpense[field] = input.options[input.selectedIndex].value;
                } else {
                    updatedExpense[field] = input.value;
                }
            });

            // file_hash beibehalten falls vorhanden
            if (existingExpense.file_hash) {
                updatedExpense.file_hash = existingExpense.file_hash;
            }

            expenses[category][index] = updatedExpense;
            renderCategory(category);
            updateTotals();
            saveData();

            // Wenn aus DB geladen, auch dort speichern
            if (currentAbrechnungId) {
                saveToDatabase();
            }

            const modal = M.Modal.getInstance(document.getElementById('edit-modal'));
            modal.close();

            M.toast({html: 'Eintrag aktualisiert', classes: 'rounded green'});
        }

        // Beleg Scanner Functions
        function openBelegScanner() {
            // Reset modal state
            document.getElementById('upload-area').style.display = 'block';
            document.getElementById('scan-progress').style.display = 'none';
            document.getElementById('scan-result').style.display = 'none';
            document.getElementById('btn-add-beleg').style.display = 'none';
            document.getElementById('beleg-input').value = '';

            const modal = M.Modal.getInstance(document.getElementById('beleg-modal'));
            modal.open();
        }

        // Initialize upload area events
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('upload-area');
            const belegInput = document.getElementById('beleg-input');

            // Click to upload
            uploadArea.addEventListener('click', () => belegInput.click());

            // Drag & Drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#333';
                uploadArea.style.background = '#f0f0f0';
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.background = 'transparent';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.background = 'transparent';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processBeleg(files[0]);
                }
            });

            // File input change
            belegInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processBeleg(e.target.files[0]);
                }
            });

            // Init select in beleg modal
            M.FormSelect.init(document.getElementById('beleg-kategorie'));
        });

        function processBeleg(file) {
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/tiff', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                M.toast({html: 'Ungültiges Dateiformat', classes: 'rounded red'});
                return;
            }

            // Show progress
            document.getElementById('upload-area').style.display = 'none';
            document.getElementById('scan-progress').style.display = 'block';
            document.getElementById('scan-result').style.display = 'none';

            // Upload and parse
            const formData = new FormData();
            formData.append('beleg', file);

            fetch('/api/parse-beleg', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('scan-progress').style.display = 'none';

                if (data.error) {
                    M.toast({html: 'Fehler: ' + data.error, classes: 'rounded red'});
                    document.getElementById('upload-area').style.display = 'block';
                    return;
                }

                // Show results
                document.getElementById('scan-result').style.display = 'block';
                document.getElementById('btn-add-beleg').style.display = 'inline-block';

                // Extract data from response (backend returns {success, data: {...}})
                const extracted = data.data || data;

                // Fill in extracted data
                document.getElementById('beleg-datum').value = extracted.datum || '';
                document.getElementById('beleg-betrag').value = extracted.betrag || '';
                document.getElementById('beleg-beschreibung').value = extracted.beschreibung || '';
                document.getElementById('beleg-rawtext').value = extracted.raw_text || '';

                // Set category if suggested
                if (extracted.kategorie_vorschlag) {
                    const katSelect = document.getElementById('beleg-kategorie');
                    katSelect.value = extracted.kategorie_vorschlag;
                    M.FormSelect.init(katSelect);
                }

                M.updateTextFields();

                // Cache-Indikator anzeigen
                if (extracted._cached) {
                    M.toast({html: '📦 Beleg aus Cache geladen', classes: 'rounded blue'});
                } else {
                    M.toast({html: 'Beleg analysiert', classes: 'rounded green'});
                }
            })
            .catch(err => {
                document.getElementById('scan-progress').style.display = 'none';
                document.getElementById('upload-area').style.display = 'block';
                M.toast({html: 'Fehler: ' + err.message, classes: 'rounded red'});
            });
        }

        function addBelegToExpenses() {
            const datum = document.getElementById('beleg-datum').value;
            const betrag = document.getElementById('beleg-betrag').value;
            const beschreibung = document.getElementById('beleg-beschreibung').value;
            const kategorie = document.getElementById('beleg-kategorie').value;

            if (!kategorie) {
                M.toast({html: 'Bitte Kategorie wählen', classes: 'rounded red'});
                return;
            }

            if (!betrag) {
                M.toast({html: 'Bitte Betrag eingeben', classes: 'rounded red'});
                return;
            }

            // Create expense based on category
            let expense = {};

            if (kategorie === 'fahrtkosten_kfz') {
                // Needs special handling - km instead of betrag
                const km = Math.round(parseFloat(betrag) / 0.30);
                expense = {
                    datum: datum,
                    fahrstrecke: beschreibung,
                    anlass: 'Aus Beleg importiert',
                    km: km.toString()
                };
            } else if (kategorie === 'fahrtkosten_pauschale') {
                expense = {
                    monat: datum,
                    beschreibung: beschreibung || 'Aus Beleg importiert',
                    betrag: betrag
                };
            } else if (kategorie === 'bewirtung') {
                expense = {
                    datum: datum,
                    personen: beschreibung || 'Aus Beleg importiert',
                    betrag: betrag
                };
            } else if (kategorie === 'sonstiges') {
                expense = {
                    typ: 'Sonstiges',
                    datum: datum,
                    ort: beschreibung || 'Aus Beleg importiert',
                    betrag: betrag
                };
            } else {
                // Standard categories: fachliteratur, bueromaterial, telefonkosten, software, getraenke
                expense = {
                    datum: datum,
                    beschreibung: beschreibung || 'Aus Beleg importiert',
                    betrag: betrag
                };
            }

            expenses[kategorie].push(expense);
            renderCategory(kategorie);
            updateTotals();
            saveData();

            // Close modal
            const modal = M.Modal.getInstance(document.getElementById('beleg-modal'));
            modal.close();

            M.toast({html: 'Beleg hinzugefügt', classes: 'rounded green'});
        }

        // ===== PDF.js Viewer =====
        // PDF.js Worker konfigurieren
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // PDF Viewer State
        let pdfDoc = null;
        let pdfPageNum = 1;
        let pdfPageCount = 0;
        let pdfScale = 1.0;
        let pdfRendering = false;
        let pdfPendingPage = null;

        function showBeleg(fileHash) {
            const downloadBtn = document.getElementById('beleg-download-btn');
            const titleEl = document.getElementById('beleg-viewer-title');
            const pdfControls = document.getElementById('pdf-controls');
            const pdfCanvas = document.getElementById('pdf-canvas');
            const imageContainer = document.getElementById('image-container');
            const belegImage = document.getElementById('beleg-image');
            const loadingEl = document.getElementById('beleg-loading');
            const errorEl = document.getElementById('beleg-error');

            // Reset state
            pdfDoc = null;
            pdfPageNum = 1;
            pdfScale = 1.0;

            // Hide all, show loading
            pdfCanvas.style.display = 'none';
            imageContainer.style.display = 'none';
            errorEl.style.display = 'none';
            pdfControls.style.display = 'none';
            loadingEl.style.display = 'block';

            // Modal öffnen
            const modal = M.Modal.getInstance(document.getElementById('beleg-viewer-modal'));
            modal.open();

            // Info laden
            fetch(`/api/beleg/${fileHash}/info`)
            .then(response => {
                if (!response.ok) throw new Error('Beleg-Info nicht gefunden');
                return response.json();
            })
            .then(info => {
                const dateiName = info.datei || 'Beleg';
                titleEl.textContent = dateiName;

                // Download-Link setzen
                const belegUrl = `/api/beleg/${fileHash}`;
                downloadBtn.href = belegUrl;
                downloadBtn.download = dateiName;

                // Dateityp bestimmen
                const ext = dateiName.split('.').pop().toLowerCase();

                if (ext === 'pdf') {
                    // PDF mit PDF.js laden
                    loadPdf(belegUrl);
                } else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'].includes(ext)) {
                    // Bild anzeigen
                    loadingEl.style.display = 'none';
                    imageContainer.style.display = 'block';
                    belegImage.src = belegUrl;
                    belegImage.onload = () => {
                        // Optional: Zoom für Bilder
                    };
                    belegImage.onerror = () => {
                        imageContainer.style.display = 'none';
                        showBelegError('Bild konnte nicht geladen werden');
                    };
                } else {
                    loadingEl.style.display = 'none';
                    showBelegError('Vorschau für diesen Dateityp nicht verfügbar');
                }
            })
            .catch(err => {
                loadingEl.style.display = 'none';
                showBelegError(err.message || 'Unbekannter Fehler');
            });
        }

        function loadPdf(url) {
            const loadingTask = pdfjsLib.getDocument(url);
            loadingTask.promise.then(pdf => {
                pdfDoc = pdf;
                pdfPageCount = pdf.numPages;
                pdfPageNum = 1;

                // Controls anzeigen
                document.getElementById('beleg-loading').style.display = 'none';
                document.getElementById('pdf-controls').style.display = 'flex';
                document.getElementById('pdf-canvas').style.display = 'block';

                updatePageInfo();

                // Erste Seite rendern mit automatischer Breitenanpassung
                pdfFitWidth();
            }).catch(err => {
                document.getElementById('beleg-loading').style.display = 'none';
                showBelegError('PDF konnte nicht geladen werden: ' + err.message);
            });
        }

        function renderPdfPage(num) {
            if (pdfRendering) {
                pdfPendingPage = num;
                return;
            }
            pdfRendering = true;

            pdfDoc.getPage(num).then(page => {
                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: pdfScale });

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                page.render(renderContext).promise.then(() => {
                    pdfRendering = false;
                    if (pdfPendingPage !== null) {
                        renderPdfPage(pdfPendingPage);
                        pdfPendingPage = null;
                    }
                });
            });

            updatePageInfo();
        }

        function updatePageInfo() {
            document.getElementById('pdf-page-info').textContent = `${pdfPageNum} / ${pdfPageCount}`;
            document.getElementById('pdf-zoom-info').textContent = `${Math.round(pdfScale * 100)}%`;
        }

        function pdfPrevPage() {
            if (pdfPageNum <= 1) return;
            pdfPageNum--;
            renderPdfPage(pdfPageNum);
        }

        function pdfNextPage() {
            if (pdfPageNum >= pdfPageCount) return;
            pdfPageNum++;
            renderPdfPage(pdfPageNum);
        }

        function pdfZoomIn() {
            pdfScale = Math.min(pdfScale + 0.25, 4.0);
            renderPdfPage(pdfPageNum);
        }

        function pdfZoomOut() {
            pdfScale = Math.max(pdfScale - 0.25, 0.25);
            renderPdfPage(pdfPageNum);
        }

        function pdfFitWidth() {
            if (!pdfDoc) return;

            pdfDoc.getPage(pdfPageNum).then(page => {
                const container = document.getElementById('beleg-viewer-content');
                const containerWidth = container.clientWidth - 40; // Padding abziehen

                const viewport = page.getViewport({ scale: 1.0 });
                pdfScale = containerWidth / viewport.width;

                renderPdfPage(pdfPageNum);
            });
        }

        function showBelegError(message) {
            document.getElementById('beleg-error').style.display = 'block';
            document.getElementById('beleg-error-msg').textContent = message;
        }
    </script>
</body>
</html>
